name: update-packages
on:
  workflow_dispatch: # allows manual triggering
  schedule:
    - cron: '0 2 * * 0' # weekly on Sunday at 2 AM

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      matrix:
        package:
          - aigpy
          - aperture-plymouth
          - bulk_extractor
          - chicago95
          - ha-mqtt-iot
          - hyperhdr
          - ipysheet
          - jackboxutility
          - kernel_driver
          - libdvbcsa-patched
          - libdyson
          - lycheeslicer
          - lyricsgenius
          - nbterm
          - oscam
          - oxyromon
          - redmond97
          - rkvm
          - se98
          - simple-term-menu
          - steamgrid
          - steamlink
          - streamrip
          - tidal-dl
          - tvheadend-patched
          - vlmcsd
          - xmount
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install nix-update
        run: |
          nix profile install nixpkgs#nix-update
      - name: Update package
        run: |
          nix-update --flake --version=unstable ${{ matrix.package }}
        continue-on-error: true
      - name: Build updated package
        id: build
        run: |
          nix build .#${{ matrix.package }} --no-link
        continue-on-error: true
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        id: pr
        with:
          commit-message: 'Update ${{ matrix.package }} to latest version'
          title: 'Update ${{ matrix.package }} to latest version'
          body: |
            Automated package update for ${{ matrix.package }}
            
            This PR was automatically generated by the update-packages workflow.
            
            Please review the changes and verify that the package builds correctly before merging.
            
            Build status: ${{ steps.build.outcome }}
          branch: update-${{ matrix.package }}-${{ github.run_id }}
          delete-branch: true
      - name: Enable Pull Request Automerge
        if: steps.pr.outputs.pull-request-operation == 'created' && steps.build.outcome == 'success'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.PAT }}
          pull-request-number: ${{ steps.pr.outputs.pull-request-number }}
